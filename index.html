<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saber Breaker - Retro Space Brick Breaker</title>
    <style>
        :root {
            --glow-primary: #0ff;
            --glow-secondary: #0ff;
            --glow-accent: #00fffb;
            --laser-color: #0ff;
            --laser-pulse: 0 0 12px #00ffff,
                           0 0 24px #00cccc,
                           0 0 36px #009999;
        }

        html, body {
            margin: 0;
            padding: 0;
            background: radial-gradient(ellipse at center, #030b15 0%, #020a13 40%, #000 100%);
            color: #e0f7ff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100%;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        /* HUD Container */
        #hud {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 5;
            padding: 8px 12px;
            background: rgba(0,20,40,0.35);
            border: 1px solid rgba(0,255,255,0.2);
            border-radius: 10px;
            box-shadow: 0 0 18px rgba(0,255,255,0.25) inset;
            backdrop-filter: blur(3px);
        }

        .hud-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 8px;
            background: linear-gradient(
                to bottom,
                rgba(0,40,55,0.6),
                rgba(0,25,40,0.5)
            );
            border: 1px solid rgba(0,255,255,0.18);
            box-shadow: 0 0 6px rgba(0,255,255,0.2) inset;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .hud-label {
            opacity: 0.8;
            font-size: 13px;
        }

        #score, #lives, #level, #highScore {
            font-variant-numeric: tabular-nums;
            font-size: 16px;
        }

        /* Color Swatches */
        #colorSwatches {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }
        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: 0 0 10px rgba(255,255,255,0.15);
            cursor: pointer;
        }

        /* Canvas */
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: radial-gradient(circle at 50% -20%, #020d1a, #000 70%);
            border: 1px solid rgba(0,255,255,0.2);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,255,255,0.15);
        }

        /* Overlay */
        #messageOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 10;
        }
        #messageOverlay.active { display: flex; }

        #messageBox {
            width: min(620px, 92vw);
            padding: 20px 22px;
            background: linear-gradient(180deg, rgba(0,24,40,0.9), rgba(0,16,28,0.9));
            border: 1px solid rgba(0,255,255,0.22);
            border-radius: 14px;
            box-shadow: 0 0 24px rgba(0,255,255,0.25);
            text-align: center;
        }
        #messageText {
            font-size: 20px;
            line-height: 1.4;
            margin-bottom: 16px;
            text-shadow: 0 0 12px rgba(0,255,255,0.25);
        }
        #overlayButton, #startButton {
            font-size: 16px;
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid rgba(0,255,255,0.4);
            background: linear-gradient(180deg, rgba(0, 60, 80, 0.8), rgba(0, 45, 70, 0.8));
            color: #e6ffff;
            cursor: pointer;
            box-shadow: 0 0 12px rgba(0,255,255,0.25);
        }

        #launchMessage {
            position: absolute;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            padding: 8px 12px;
            border: 1px solid rgba(0,255,255,0.3);
            border-radius: 8px;
            background: rgba(0, 30, 40, 0.6);
            box-shadow: 0 0 12px rgba(0,255,255,0.2);
            z-index: 4;
            display: none;
        }

        /* High score list */
        #highScoreList {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 25, 40, 0.6);
            border: 1px solid rgba(0,255,255,0.2);
        }

        /* Mobile tweaks */
        @media (max-width: 640px) {
            #hud { gap: 8px; }
            #messageText { font-size: 18px; }
            #launchMessage { bottom: 72px; }
        }
    </style>
</head>
<body>
    <div id="hud">
        <div class="hud-chip"><span class="hud-label">Score</span><span id="score">0000</span></div>
        <div class="hud-chip"><span class="hud-label">Lives</span><span id="lives">3</span></div>
        <div class="hud-chip"><span class="hud-label">Level</span><span id="level">1</span></div>
        <div class="hud-chip"><span class="hud-label">High</span><span id="highScore">0000</span></div>
        <div id="colorSwatches" aria-label="Lightsaber Colors">
            <div class="color-swatch" data-color="#0ff" style="background-color:#0ff"></div>
            <div class="color-swatch" data-color="#ff2e63" style="background-color:#ff2e63"></div>
            <div class="color-swatch" data-color="#7cff00" style="background-color:#7cff00"></div>
            <div class="color-swatch" data-color="#ffd166" style="background-color:#ffd166"></div>
            <div class="color-swatch" data-color="#b388ff" style="background-color:#b388ff"></div>
        </div>
        <button id="startButton">Start</button>
    </div>

    <div id="messageOverlay">
        <div id="messageBox">
            <div id="messageText"></div>
            <div id="highScoreList" style="display:none"></div>
            <button id="overlayButton">Continue</button>
        </div>
    </div>

    <div id="launchMessage">Tap or click to launch!</div>

    <canvas id="gameCanvas" width="960" height="640"></canvas>

    <script>
        (function() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            const messageOverlay = document.getElementById('messageOverlay');
            const messageText = document.getElementById('messageText');
            const overlayButton = document.getElementById('overlayButton');
            const startButton = document.getElementById('startButton');
            const colorSwatchesContainer = document.getElementById('colorSwatches');

            const scoreEl = document.getElementById('score');
            const livesEl = document.getElementById('lives');
            const levelEl = document.getElementById('level');
            const highScoreEl = document.getElementById('highScore');

            const launchMsg = document.getElementById('launchMessage');

            let W = canvas.width, H = canvas.height;

            function updateCanvasDimensions() {
                const dpr = Math.min(window.devicePixelRatio || 1, 2);
                const maxW = Math.min(window.innerWidth - 16, 1200);
                const maxH = Math.min(window.innerHeight - 16, 800);
                const aspect = 960/640;
                let newW = maxW;
                let newH = Math.floor(maxW / aspect);
                if (newH > maxH) {
                    newH = maxH;
                    newW = Math.floor(newH * aspect);
                }
                canvas.style.width = newW + 'px';
                canvas.style.height = newH + 'px';
                canvas.width = Math.floor(newW * dpr);
                canvas.height = Math.floor(newH * dpr);
                W = canvas.width; H = canvas.height;
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }

            // --- Audio (placeholder simple synth-like via Tone.js style API, mocked) ---
            const Tone = {
                start: () => Promise.resolve(),
            };
            const explosionSynth = { triggerAttackRelease: () => {} };
            const fanfareSynth = { triggerAttackRelease: () => {} };
            function playFanfare() { fanfareSynth.triggerAttackRelease('C4','8n'); }

            const PU_TYPE = { WIDEN:0, MULTI:1, SHRINK:2, LASER:3, SHIELD:4 };
            const PU_COLORS = {
                0: '#39c5bb', 1: '#ffd166', 2: '#ff2e63', 3: '#b388ff', 4: '#7cff00'
            };

            const BOSS_LEVEL = 99;
            const maxLevels = 5;

            const gameState = {
                running: false,
                currentLevel: 1,
                score: 0,
                lives: 3,
                highScore: 0,
                balls: [],
                ballReady: true,
                paddleX: 420,
                paddleW: 100,
                brickRows: 6,
                brickCols: 10,
                bricks: [],
                powerUps: [],
                isPaddleExtended: false,
                lightsaberColor: '#0ff',
                currentSaberColor: '#0ff',
                levelComplete: false,
                boss: null
            };

            function updateSaberColor(color) {
                gameState.lightsaberColor = color;
                document.documentElement.style.setProperty('--glow-primary', color);
                document.documentElement.style.setProperty('--glow-secondary', color);
                document.documentElement.style.setProperty('--glow-accent', color);
                document.documentElement.style.setProperty('--laser-color', color);
            }

            function drawHUD() {
                scoreEl.textContent = String(gameState.score).padStart(4,'0');
                livesEl.textContent = String(gameState.lives);
                levelEl.textContent = String(gameState.currentLevel === BOSS_LEVEL ? 'Boss' : gameState.currentLevel);
                highScoreEl.textContent = String(gameState.highScore).padStart(4,'0');
            }

            function initBricks(level) {
                const rows = Math.min(gameState.brickRows + level - 1, 10);
                const cols = gameState.brickCols;
                gameState.bricks = [];
                for (let r=0;r<rows;r++){
                    for (let c=0;c<cols;c++){
                        const x = 30 + c*((W-60)/cols);
                        const y = 60 + r*28;
                        gameState.bricks.push({ x, y, w: (W-60)/cols - 4, h: 22, hp: 1 + Math.floor(level/2), color: `hsla(${(c*36)%360}, 70%, 55%, 0.95)` });
                    }
                }
            }

            function spawnParticles(x, y, color) {
                // Placeholder; in the original game, this would animate particles.
                // Here we keep it light.
            }

            function spawnPowerUp(x, y) {
                // Placeholder
            }

            function processScoreChange(delta) {
                gameState.score += delta;
                if (gameState.score > gameState.highScore) gameState.highScore = gameState.score;
                drawHUD();
            }

            function drawPaddle() { /* ... drawing code ... */ }
            function drawBall() { /* ... drawing code ... */ }
            function drawBricks() { /* ... drawing code ... */ }
            function drawBoss() { /* ... drawing code ... */ }

            function screenShake(mag=10, dur=2) { /* ... */ }

            function resetBallAndPaddle() {
                gameState.balls = [{ x: W/2, y: H-80, r: 8, dx: 0, dy: 0 }];
                gameState.ballReady = true;
                launchMsg.style.display = 'block';
            }

            function startGame() {
                gameState.running = true;
                messageOverlay.classList.remove('active');
                startButton.style.display = 'none';
                initBricks(gameState.currentLevel);
                resetBallAndPaddle();
                loop();
            }

            function endGame(victory=false) {
                gameState.running = false;
                if (!victory) {
                    messageText.innerHTML = `MISSION FAILED<br>FINAL SCORE: ${gameState.score}`;
                    overlayButton.textContent = 'RETRY';
                } else {
                    messageText.innerHTML = `VICTORY!<br>FINAL SCORE: ${gameState.score}`;
                    overlayButton.textContent = 'PLAY AGAIN';
                }
                document.getElementById('highScoreList').style.display = 'block';
                startButton.style.display = 'inline-block';
                messageOverlay.classList.add('active');
            }

            function nextLevel() {
                Tone.start().then(() => playFanfare());

                const completedLevel = gameState.currentLevel; 
                const nextLevelDisplay = completedLevel === maxLevels
                    ? `LEVEL ${completedLevel} COMPLETE!<br>ATTACK THE STAR DESTROYER!`
                    : `LEVEL ${completedLevel} COMPLETE!<br>INCOMING: LEVEL ${completedLevel + 1} FLEET!`;
                
                if (completedLevel === maxLevels) {
                    gameState.currentLevel = BOSS_LEVEL;
                } else {
                    gameState.currentLevel++;
                }

                messageText.innerHTML = nextLevelDisplay;
                overlayButton.textContent = gameState.currentLevel === BOSS_LEVEL ? "ATTACK STAR DESTROYER" : "CONTINUE";
                messageText.style.color = gameState.lightsaberColor; 
                highScoreList.style.display = 'none';
                messageOverlay.classList.add('active');
                
                overlayButton.onclick = () => {
                    startButton.style.display = 'none';
                    initBricks(gameState.currentLevel);
                    resetBallAndPaddle();
                    messageOverlay.classList.remove('active');
                    gameState.running = true;
                };
            }

            function bossHit(x,y,w,h) {
                if (!gameState.boss) return;
                gameState.boss.health--;
                Tone.start().then(() => explosionSynth.triggerAttackRelease("C2", "8n"));
                screenShake(50, 2); 
                
                processScoreChange(2); 
                
                if (gameState.boss.health <= 0) {
                    spawnParticles(x, y, '#ff4136'); 
                    spawnParticles(x + w/2, y + h/2, '#ff4136');
                    Tone.start().then(() => explosionSynth.triggerAttackRelease("C1", "4n"));
                    gameState.levelComplete = true; 
                }
                
                setTimeout(() => {
                    /* continue boss behavior */
                }, 200);
            }

            function loop() {
                if (!gameState.running) return;
                ctx.clearRect(0,0,W,H);
                drawBricks();
                drawPaddle();
                drawBall();
                if (gameState.currentLevel === BOSS_LEVEL) drawBoss();
                requestAnimationFrame(loop);
            }

            function init() {
                updateCanvasDimensions();
                
                // Color Swatch Logic
                if (colorSwatchesContainer) {
                    colorSwatchesContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('.color-swatch');
                        if (target) {
                            updateSaberColor(target.dataset.color);
                        }
                    });
                    updateSaberColor(gameState.currentSaberColor);
                }
                
                window.addEventListener('resize', updateCanvasDimensions); 
                document.addEventListener('mousemove', mouseMoveHandler, false);
                canvas.addEventListener('touchmove', touchMoveHandler, { passive: false });
                
                messageText.innerHTML = "WELCOME TO SABER BREAKER!<br>DESTROY THE IMPERIAL FLEET WITH YOUR LIGHTSABER.";
                overlayButton.textContent = "BEGIN MISSION";
                messageOverlay.classList.add('active');
                
                startButton.onclick = startGame;
                overlayButton.onclick = startGame; 

                loop();
                // Clean launch bindings
                canvas.addEventListener('click', launchBall);
                canvas.addEventListener('touchstart', launchBall, { passive: true });
 
            }

            // --- INPUT HANDLERS ---
            function mouseMoveHandler(e) {
                if (!gameState.running) return;
                const relativeX = e.clientX - canvas.getBoundingClientRect().left;
                
                // Use the total width of the saber for centering the input
                const currentSaberW = gameState.isPaddleExtended ? 150 : gameState.paddleW;

                if (relativeX > 0 && relativeX < W) {
                    gameState.paddleX = relativeX - currentSaberW / 2;
                }
            }

            function touchMoveHandler(e) {
                if (!gameState.running || e.touches.length === 0) return;
                e.preventDefault(); 
                
                const touch = e.touches[0];
                const relativeX = touch.clientX - canvas.getBoundingClientRect().left;

                // Use the total width of the saber for centering the input
                const currentSaberW = gameState.isPaddleExtended ? 150 : gameState.paddleW;

                if (relativeX > 0 && relativeX < W) {
                    gameState.paddleX = relativeX - currentSaberW / 2;
                }
            }
            // --- END INPUT HANDLERS ---
            
            // Unified launcher for click/tap
            function launchBall() {
                if (gameState.ballReady && gameState.balls.length > 0) {
                    const ball = gameState.balls[0];
                    const speed = 4.0;
                    const angle = (Math.random() * Math.PI) / 3 + Math.PI / 6;
                    ball.dx = speed * Math.cos(angle) * (Math.random() < 0.5 ? 1 : -1);
                    ball.dy = -Math.abs(speed * Math.sin(angle));
                    gameState.ballReady = false;
                    document.getElementById('launchMessage').style.display = 'none';
                }
            }
            
            window.onload = init;
        })();
    </script>
</body>
</html>
